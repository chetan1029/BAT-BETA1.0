{% extends "base.html" %}
{% load i18n %}
{% load l10n %}
{% load crispy_forms_tags permission_tags core_utils %}
{% block title %}
{% translate 'Add staff member' %}
{% endblock title %}
{% block table_style %}{% endblock %}
{% block form_style %}{% endblock %}
{% block content %}
<main>
  <div class="container-fluid">
    {% include "sidebar.html" %}
    <div class="row">
      <div class="col-md-6">
        <h1>{% translate 'Add staff member' %}</h1>
      </div>
    </div>

    <div class="separator mb-5"></div>
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-body">
              <h5 class="mb-4">{% translate 'Member Detail' %}</h5>

              {% include "global/messages.html" %}
              {% include "global/errors.html" %}
              <form method="POST" novalidate id="perm-assign-form">
                {% csrf_token %}
                {{form.roles}}
                {{form.permissions}}
                {{form.company_id}}
                <div class="row form-row">
                  <div class="col-md-4">
                    {{ form.job_title|as_crispy_field }}
                  </div>
                  <div class="col-md-4">
                    {{ form.first_name|as_crispy_field }}
                  </div>
                  <div class="col-md-4">
                    {{ form.last_name|as_crispy_field }}
                  </div>
                </div>
                <div class="row form-row">
                  <div class="col-md-12">
                    {{ form.email|as_crispy_field }}
                  </div>
                </div>
                <h5 class="mb-4">{% translate 'Permissions' %}</h5>
                <div class="row mt-2">
                  <div class="col">
                    <div class="accordion" id="rolesAssignment">
                      {% for role, meta in available_roles.items %}
                      <div class="card shadow-none border mb-2">
                        <div class="card-header pb-0" id="heading{{role}}">
                          <div class="custom-control custom-radio my-3">
                            <input type="radio" class="custom-control-input role-selector" name="radiorole" id="customCheck-{{role}}"
                            data-role="{{role}}" />
                            <label class="custom-control-label h6" for="customCheck-{{role}}">
                              {{meta.display_name}}
                            </label>

                            <button class="btn btn-link p-0 float-right" type="button" data-toggle="collapse"
                              data-target="#collapse{{role}}" aria-expanded="true" aria-controls="collapse{{role}}}}">
                              <h5 class="mb-0"><i class="iconsmind-Arrow-Down font-weight-bold"></i></h5>
                            </button>
                          </div>
                        </div>

                        <div id="collapse{{role}}" class="collapse show" aria-labelledby="heading{{role}}"
                          data-parent="#rolesAssignment">
                          <div class="card-body pt-1">
                            <div class="row pl-3">
                              {% for perm, perm_name in meta.permissions.items %}
                              <div class="col-lg-3">
                                <div class="custom-control custom-checkbox">
                                  <input type="checkbox" class="custom-control-input perm-selector"
                                    id="perm-{{perm}}" data-role="{{role}}"
                                    data-perm="{{perm}}" />
                                  <label class="custom-control-label" for="perm-{{perm}}">{{perm_name}}</label>
                                </div>
                              </div>
                              {% endfor %}
                            </div>
                          </div>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary mb-0">{% translate 'Submit' %}</button>
              </form>
            </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}
{% block chart_script %}{% endblock %}
{% block table_script %}{% endblock %}
{% block form_script %}{% endblock %}
{% block script %}

<script type="text/javascript">
  $(".role-selector").on('change', function () {
    var role = $(this).data('role');
    var selected = $(this)[0].checked;
    $("#rolesAssignment input[type='checkbox']").prop('checked', false);
    $("[data-role='" + role + "']").prop('checked', selected);
  });

  $("#perm-assign-form").on('submit', function (e) {
    var selectedRoles = [];
    var selectedPerms = [];
    $(".role-selector:checked").each(function (idx, el) {
      selectedRoles.push($(this).data('role'));
    });

    $(".perm-selector:checked").each(function (idx, el) {
      if (selectedRoles.indexOf($(this).data('role')) === -1)
        selectedRoles.push($(this).data('role'));
      selectedPerms.push($(this).data('perm'));
    });
    $("#id_roles").val(selectedRoles.join(","));
    $("#id_permissions").val(selectedPerms.join(","));
    return true;
  });
</script>
{% endblock %}
